ch02.Elixirビルド時に何が起こっているか
=======================================

makeコマンドでElixirをビルドする時、何が起こっているかをいくつかのフェーズに分けて説明していきます。

## 全体の流れ

makeを行うとMakefileの内容でElixirがビルドされます。ビルドは大きく以下のフェーズに分けられます。

1. rebarを使ってErlangで記述されたElixirコンパイラをコンパイル
2. Elixirコンパイラを使ってElixirで記述されたElixirカーネルをコンパイル
3. Elixirコンパイラを使ってElixirで記述された関連ツール(eex,mix,ex_unit,logger,iex)をコンパイル

## Elixirコンパイラ

makeコマンドを実行するとまずElixirコンパイラがコンパイルされます。
この時、以下の処理が実行されます。

```bash
cd /path/to/elixir/repo/lib/elixir && ../../rebar compile
```

コンパイルの順は以下となります。

1. elixir/src/elixir.app.srcをelixir/lib/elixir/srcにコピーする
2. elixir/lib/elixir/src以下のErlangコードをコンパイルしてelixir/lib/elixir/ebin以下に実行ファイル(.beam,.app)として配置する

src以下のErlangソースコードは4種類あります。

### elixir.app.src

elixir.app.srcはelixir.appのテンプレートファイルです。これを元にelixir.appとしてebin以下に配置されます。

### elixir.hrl

elixir.hrlはErlangのヘッダファイルです。Elixirコンパイラモジュールに関する定義等が記述されています。

### elixir_xxx.erl

elixir_xxx.erlはErlangのソースコードです。 コンパイルされるとebin以下にelixir_xxx.beamとして配置されます。

### elixir_parser.yrl

elixir_parser.yrlはyeccパーサージェネレーターファイル、yeccはErlangのLALR(1)パーサージェネレータです。

パーサージェネレータとは何ぞやという方は、(yeccではなくyacc,raccなんですが) RHGの[速習yacc](http://i.loveruby.net/ja/rhg/book/yacc.html)、[Rubyを256倍使うための本 無道編](http://www.amazon.co.jp/Rubyを256倍使うための本-無道編-青木-峰郎/dp/4756137091)をオススメします。

yeccの詳しい使い方は[Erlangの公式ドキュメント](http://erlang.org/doc/man/yecc.html)を参照して下さい。 まとまった日本語の情報は残念ながら見つけられませんでした。 yeccについてはパース関連の章で掘り下げて説明します。

コンパイルが走ると、elixir_parser.yrlからelixir_parser.erl が生成され、さらにebin以下にelixir_parser.beamができます。

## Elixirカーネル

Elixirコンパイラのコンパイルが終わると、
次にElixirカーネルがコンパイルされます。
Elixirカーネルのコンパイルは以下のフェーズに分けられます。

1. ElixirコンパイラでElixirで記述されたコアモジュールをコンパイル
2. bin/elixircでElixirで記述されたカーネルモジュールをコンパイル
3. bin/elixircでElixirで記述された標準ライブラリをコンパイル
4. bin/elixircでElixirで記述されたUnicodeモジュールをコンパイル
5. elixir.appを削除して、rebarでErlangで記述されたElixirコンパイラを再コンパイル

### コアモジュール

コアモジュールはElixirコンパイラでコンパイルされます。
この時、以下の処理が実行されます。

```bash
cd /path/to/elixir/repo/lib/elixir
erl -I lib/elixir/include -noshell -pa lib/elixir/ebin -s elixir_compiler core -s erlang halt
```
`erl`はErlangランタイムを呼び出すコマンドです。
ここでは以下のオプションを付けて起動しElixirコンパイラから、
コアモジュールをコンパイルしています。

#### -I lib/elixir/include



#### -noshell

-noshellを付けるとErlangの対話シェルを起動せずに実行します。
ただし標準入力を閉じはしないので、
処理が完了したら明示的にコマンドを終了される必要があります。

#### -pa lib/elixir/ebin

-paは後ろに続くディレクトリをコードパス(の先頭)に追加します。
ここではlib/elixir/ebin以下のモジュールがプログラム実行時にロードされます。

#### -s elixir_compiler core

-s Mod Func を指定する事で、erl実行時に
Modモジュールの関数Funcを実行する事ができます。
ここでは、elixir_compilerモジュールのcore関数が実行されます。

#### -s erlang halt

-noshellで起動しているので、明示的に終了するよう
erlangモジュールのhalt関数を実行して終了させます。






### bin/elixirc

### カーネルモジュール

### 標準ライブラリ

### Unicodeモジュール

### Elixirコンパイラの再コンパイル

## 関連ツール(`eex`,`mix`,`ex_unit`,`logger`,`iex`)
